# Eghtesad Novin Ckeckout:
Unofficial [Novin Pardakht - Eghtesad Novin Gateway](https://www.pna.co.ir) implementation in Node.JS

Warning: Eghtesad Novin gateway API's are not persistent and they will change without notifing users.

This module needs `openssl` installed on your computer (or server) and should be visible in `$PATH`. (Pre-installed on most linux distros - except light weight docker images)  

Notice: They are not checking IP's so you can test it on your development machine.

- [Installation](#installation)
  - [NPM](#npm)
  - [Yarn](#yarn)

- [Usage](#usage)
  - [Create An Instance](#create-an-instance)
  - [API](#api)

- [Related projects](#related-projects)

## Installation
Install the package from 'npm' or 'yarn'.
### NPM
```bash
npm install eghtesad-novin-checkout
```
### Yarn
```bash
yarn add eghtesad-novin-checkout
```
## Usage:
### Create An Instance

Import the package:
```
const EghtesadNovin = require('eghtesad-novin-checkout');
// or (ES6):
import EghtesadNovin from 'eghtesad-novin-checkout';
```
Then create an instance:
```
const eghtesadNovin = new EghtesadNovin({
  username: 'xxxxxxx',
  password: 'xxxxxxx',
  pemKeyAddress: './private.pem' // the one that they emailed to you
});
```

### API
#### Request Token:
```javascript
eghtesadNovin.requestPaymentToken(
  1000, // String, Payment Amount In Rials
  '12345678912', // String, invoiceNumber Generated By You
  'https://call.back/enbank' // Payment Callback URL
).then(function (response) {
  // send this token to client and make a Post request with token from there
  console.log(response.token, response.expirationDate);
}).catch(function (error) {
  console.error(error);
});
```

#### Client side:
Here is an example of client side.
```html
<html>
 <body>
  <script>
   var f = document.createElement('form');
   f.action='https://pna.shaparak.ir/_ipgw_/payment/';      // back endpoint 
   f.method='POST';

   var i=document.createElement('input');
   i.type='hidden';
   i.name='token';
   i.value='XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX';		// your bank token
   f.appendChild(i);

   var j=document.createElement('input');
   j.type='hidden';
   j.name='language';
   j.value='fa';
   f.appendChild(j);

   document.body.appendChild(f);
   f.submit();
  </script>
 </body>
</html>
```

After making Post request to bank URL, user will follow bank instructions then he will posted to your callbackUrl, make sure that your endpoint should accept Post method.  
These parameters will be accesible via bank Post request in endpoint:
  - State // if payment is successfull they will send "ok" string (do toLowerCase to avoid furture problems)
  - token // same as your request
  - RefNum // use to finalize payment
  - traceNumLbl // actually this should be RefNum

#### Payment Finalization:
```javascript
enghtesadNovin.recievePay(
  'XXXXXXXXXX', // token
  '1111111111' // RefNum, Get From Payment Callback Post Params
).then(function (response) {
  console.log(response.TraceNo, response.traceNumLbl, response.CustomerRefNum, response.CardMaskPan, response.CardHashPan);
  // some of values may not sent from bank
}).catch(function (error) {
  console.error(error);
});
```

#### Related projects:
Thanks to Sina Bakhtiari there is an open source [Unofficial NodeJS implementation of Behpardakht Mellat Gateway API](https://github.com/sinabakh/mellat-checkout) available.
